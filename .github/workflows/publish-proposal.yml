name: Publish Proposal

# Reusable workflow to publish a single WASI proposal to GHCR

on:
  workflow_call:
    inputs:
      proposal:
        description: 'Name of the proposal to publish'
        required: true
        type: string
      description:
        description: 'Description of the proposal'
        required: true
        type: string
      version:
        description: 'Version to publish'
        required: true
        type: string
      wit_dir:
        description: 'WIT directory (wit or wit-0.3.0-draft)'
        required: true
        type: string
      wkg_version:
        description: 'Version of wkg to install'
        required: false
        type: string
        default: '0.14.0'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
      contents: write
      attestations: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@ec80feb9e330418e014932e5982599255eff6dbb # v1.17.4

      - name: Install wkg
        shell: bash
        run: cargo binstall -y "wkg@${{ inputs.wkg_version }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ORG_PAT }}

      - name: Build WIT package
        shell: bash
        working-directory: proposals/${{ inputs.proposal }}
        run: |
          echo "Building ${{ inputs.proposal }} from: $(pwd)"
          wkg wit build -o "$GITHUB_WORKSPACE/wasi-${{ inputs.proposal }}.wasm" --wit-dir "${{ inputs.wit_dir }}"

      - name: Publish to GitHub Container Registry
        id: publish
        uses: bytecodealliance/wkg-github-action@10b3b04b9059ba46208cd7daf7d352af14bded0f # v5
        with:
          oci-reference-without-tag: 'ghcr.io/webassembly/wasi/${{ inputs.proposal }}'
          file: 'wasi-${{ inputs.proposal }}.wasm'
          description: ${{ inputs.description }}
          source: 'https://github.com/webassembly/wasi'
          homepage: 'https://wasi.dev'
          version: ${{ inputs.version }}
          licenses: 'Apache-2.0 WITH LLVM-exception'

      - name: Attest build provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-name: ghcr.io/webassembly/wasi/${{ inputs.proposal }}
          subject-digest: ${{ steps.publish.outputs.digest }}
          push-to-registry: true
          github-token: ${{ secrets.ORG_PAT }}
